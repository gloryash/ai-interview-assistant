# 文档生成机制

> 文档版本：v1.0
> 更新日期：2026-01-29

---

## 1. 概述

本项目的核心价值之一是：**通过 AI 访谈自动生成结构化文档**。

本文档介绍文档生成的完整流程、技术实现和最佳实践。

---

## 2. 生成流程

```
┌──────────────┐
│   开始访谈    │
└──────────────┘
       │
       ▼
┌──────────────┐     实时记录      ┌──────────────┐
│  语音对话     │ ───────────────▶ │  Transcript   │
│  (用户 ↔ AI)  │                  │  (访谈记录)    │
└──────────────┘                   └──────────────┘
       │                                  │
       │ 结束访谈                          │
       ▼                                  │
┌──────────────┐                          │
│  点击生成文档  │                          │
└──────────────┘                          │
       │                                  │
       ▼                                  ▼
┌──────────────────────────────────────────────┐
│              DocumentGenerator                │
│  ┌────────────────────────────────────────┐  │
│  │  for each output in scenario.outputs:  │  │
│  │    1. 构建 prompt                       │  │
│  │    2. 调用 LLM                          │  │
│  │    3. 流式输出                          │  │
│  └────────────────────────────────────────┘  │
└──────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│  生成的文档    │
│  (PRD, 用户画像等) │
└──────────────┘
```

---

## 3. 核心组件

### 3.1 Transcript（访谈记录）

```typescript
interface InterviewTranscript {
  scenarioId: string;
  startTime: Date;
  endTime?: Date;
  messages: TranscriptMessage[];
}

interface TranscriptMessage {
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}
```

访谈记录是文档生成的**唯一输入**，包含完整的对话历史。

### 3.2 DocumentGenerator

```typescript
class DocumentGenerator {
  async generate(
    transcript: InterviewTranscript,
    output: OutputConfig,
    onProgress?: (chunk: string, charCount: number) => void
  ): Promise<GeneratedDocument>
}
```

文档生成器负责：
1. 将访谈记录格式化为 LLM 可理解的文本
2. 结合 generatorPrompt 构建完整 prompt
3. 调用 LLM 生成文档
4. 流式返回生成进度

---

## 4. Prompt 构建

### 4.1 完整 Prompt 结构

```
[generatorPrompt]          ← 来自 OutputConfig
---
以下是访谈记录：

用户：...
AI：...
用户：...
AI：...
...
```

### 4.2 示例

```
你是一位资深产品经理，请基于以下访谈记录生成一份专业的 PRD 文档。

## 输出要求
- 使用 Markdown 格式
- 语言专业但易懂
...

---
以下是访谈记录：

用户：我想做一个帮学生背单词的 App
AI：这个想法很棒！能告诉我这个 App 主要解决什么问题吗？
用户：主要是学生背单词太枯燥，容易放弃
...
```

---

## 5. 流式生成

为了提升用户体验，文档生成采用**流式输出**：

```typescript
// 调用示例
await generator.generate(transcript, output, (chunk, charCount) => {
  // chunk: 本次新增的文本片段
  // charCount: 已生成的总字符数
  console.log(`已生成 ${charCount} 字`);
});
```

UI 层可以：
- 实时显示生成进度
- 展示"正在生成..."动画
- 显示已生成字符数

---

## 6. 多文档生成

一个场景可以配置多个产出物，生成时会**依次**生成：

```typescript
// useInterview.ts 中的实现
const generateDocuments = async () => {
  for (const output of scenario.outputs) {
    const doc = await generator.generate(transcript, output, onProgress);
    documents.push(doc);
  }
};
```

生成顺序由 `outputs` 数组顺序决定。

---

## 7. 生成的文档结构

```typescript
interface GeneratedDocument {
  outputId: string;      // 对应 OutputConfig.id
  name: string;          // 文档名称
  content: string;       // Markdown 内容
  generatedAt: Date;     // 生成时间
}
```

---

## 8. 导出功能

生成的文档支持导出为 Markdown 文件：

```typescript
const handleExport = (doc: GeneratedDocument) => {
  const blob = new Blob([doc.content], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${doc.name}.md`;
  a.click();
  URL.revokeObjectURL(url);
};
```

---

## 9. 最佳实践

### 9.1 generatorPrompt 编写建议

| 建议 | 说明 |
|-----|------|
| 明确输出格式 | 指定使用 Markdown |
| 定义文档结构 | 列出章节大纲 |
| 处理缺失信息 | 标注"待补充" |
| 控制篇幅 | 避免过长或过短 |

### 9.2 访谈记录质量

文档质量取决于访谈记录质量：
- 访谈要充分，信息要完整
- AI 要善于追问，挖掘细节
- 用户回答要具体，避免空泛

---

## 10. 总结

文档生成机制的核心是：

1. **访谈记录** - 完整记录对话内容
2. **generatorPrompt** - 定义生成规则
3. **LLM 调用** - 结构化输出
4. **流式展示** - 提升用户体验
