# Prompt 驱动架构设计

> 文档版本：v1.0
> 更新日期：2026-01-29

---

## 1. 设计理念

### 1.1 核心思想

本项目采用 **Prompt 驱动架构**，核心理念是：

> **一套代码，多种场景。通过切换 Prompt 配置，而非修改代码，来适配不同的访谈场景。**

这意味着：
- AI 产品访谈、助教复盘、用户调研等场景，共用同一套语音交互引擎
- 不同场景的差异，完全通过配置文件（ScenarioConfig）来定义
- 新增场景只需添加配置，无需修改核心代码

### 1.2 为什么选择这种架构？

| 传统方式 | Prompt 驱动方式 |
|---------|----------------|
| 每个场景写一套代码 | 一套代码适配所有场景 |
| 修改逻辑需要改代码 | 修改 Prompt 即可调整行为 |
| 开发者才能调整 | 产品经理也能调整 |
| 扩展成本高 | 扩展成本极低 |

---

## 2. 三层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      场景配置层                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ AI产品访谈   │ │  助教复盘    │ │  用户调研    │  ...      │
│  │ Scenario    │ │  Scenario   │ │  Scenario   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│         │               │               │                   │
│         └───────────────┼───────────────┘                   │
│                         ▼                                   │
├─────────────────────────────────────────────────────────────┤
│                      访谈引擎层                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              InterviewEngine                         │   │
│  │  ┌─────────────┐  ┌─────────────┐                   │   │
│  │  │ StateMachine │  │ DocGenerator │                  │   │
│  │  │  (阶段管理)   │  │  (文档生成)   │                  │   │
│  │  └─────────────┘  └─────────────┘                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│                         ▼                                   │
├─────────────────────────────────────────────────────────────┤
│                      语音交互层                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           useRealtimeVoiceChat                       │   │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐           │   │
│  │  │ ASR │ │ TTS │ │ VAD │ │ LLM │ │Audio│           │   │
│  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘           │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.1 语音交互层（底层）

**职责**：处理语音输入输出，与 LLM 对话

**核心组件**：
- `useRealtimeVoiceChat` - 语音对话主 Hook
- `useASR` - 语音识别
- `useTTS` - 语音合成
- `useVoiceInteraction` - 语音交互状态机
- `useAudioPlayer` / `useAudioRecorder` - 音频播放/录制

**特点**：
- 完全通用，不包含任何业务逻辑
- 通过回调函数暴露事件（onUserMessage, onAssistantMessage）
- 可独立使用，也可被上层封装

### 2.2 访谈引擎层（中间层）

**职责**：管理访谈流程，生成文档

**核心组件**：
- `InterviewEngine` - 访谈引擎
- `InterviewStateMachine` - 阶段状态机
- `DocumentGenerator` - 文档生成器
- `useInterview` - 访谈 Hook

**特点**：
- 读取场景配置，驱动访谈流程
- 记录访谈内容（transcript）
- 根据配置生成多种文档

### 2.3 场景配置层（顶层）

**职责**：定义具体场景的行为

**核心组件**：
- `ScenarioConfig` - 场景配置接口
- 各场景配置文件（如 `ai-interview.ts`）

**特点**：
- 纯配置，无代码逻辑
- 定义访谈 Prompt、阶段、产出物
- 新增场景只需添加配置文件

---

## 3. 核心数据结构

### 3.1 ScenarioConfig（场景配置）

```typescript
interface ScenarioConfig {
  id: string;                    // 场景唯一标识
  name: string;                  // 场景名称
  interviewPrompt: string;       // 访谈 AI 的系统 Prompt
  stages: StageConfig[];         // 访谈阶段列表
  outputs: OutputConfig[];       // 产出物配置
}
```

### 3.2 StageConfig（阶段配置）

```typescript
interface StageConfig {
  id: string;                    // 阶段标识
  name: string;                  // 阶段名称
  prompt: string;                // 阶段目标描述
  requiredFields: string[];      // 该阶段需收集的信息
}
```

### 3.3 OutputConfig（产出物配置）

```typescript
interface OutputConfig {
  id: string;                    // 产出物标识
  name: string;                  // 产出物名称
  generatorPrompt: string;       // 生成该文档的 Prompt
  template?: string;             // 可选的模板
}
```

---

## 4. 数据流

```
┌──────────────┐
│ 用户选择场景  │
└──────────────┘
       │
       ▼
┌──────────────┐     加载配置      ┌──────────────┐
│ScenarioConfig│ ◀───────────────  │ 配置文件      │
└──────────────┘                   └──────────────┘
       │
       │ 注入 interviewPrompt
       ▼
┌──────────────┐
│  ChatProvider │ ◀─── systemPrompt = interviewPrompt
└──────────────┘
       │
       │ 开始访谈
       ▼
┌──────────────┐     语音/文字     ┌──────────────┐
│    用户       │ ◀──────────────▶ │     AI       │
└──────────────┘                   └──────────────┘
       │
       │ 记录对话
       ▼
┌──────────────┐
│  Transcript   │ ◀─── 访谈记录
└──────────────┘
       │
       │ 访谈结束，生成文档
       ▼
┌──────────────┐     遍历 outputs   ┌──────────────┐
│DocGenerator  │ ──────────────────▶│ 生成的文档    │
└──────────────┘                    └──────────────┘
```

---

## 5. 关键设计决策

### 5.1 一个访谈 Agent，多个文档 Agent

```
                    ┌─────────────────┐
                    │  访谈 Agent      │
                    │ (interviewPrompt)│
                    └─────────────────┘
                            │
                            │ 访谈记录
                            ▼
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ PRD Agent   │     │用户画像 Agent│     │ 其他 Agent  │
│(generatorPrompt)│ │(generatorPrompt)│ │(generatorPrompt)│
└─────────────┘     └─────────────┘     └─────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
   PRD 文档            用户画像文档          其他文档
```

**为什么这样设计？**
- 访谈 Agent 专注于引导对话、收集信息
- 文档 Agent 专注于结构化输出、格式润色
- 职责分离，各司其职，效果更好

### 5.2 流程透明化

```
语音输入 ──▶ 文字记录 ──▶ 文档产出
   │            │            │
   ▼            ▼            ▼
 可听到       可查看       可下载
```

每个环节的输入输出都清晰可见，用户可以：
- 实时看到语音识别结果
- 查看完整的访谈记录
- 预览和下载生成的文档

### 5.3 配置优先于代码

| 需要修改的内容 | 修改方式 |
|--------------|---------|
| 访谈风格 | 修改 `interviewPrompt` |
| 访谈阶段 | 修改 `stages` 数组 |
| 产出文档类型 | 修改 `outputs` 数组 |
| 文档格式 | 修改 `generatorPrompt` |
| 新增场景 | 添加新的配置文件 |

---

## 6. 扩展性设计

### 6.1 新增场景

只需在 `src/config/scenarios/` 下添加新的配置文件：

```typescript
// src/config/scenarios/ta-review.ts
export const taReviewScenario: ScenarioConfig = {
  id: 'ta-review',
  name: '助教复盘',
  interviewPrompt: `你是一位经验丰富的助教...`,
  stages: [...],
  outputs: [...]
};
```

然后在 `index.ts` 中注册即可。

### 6.2 新增产出物

在场景配置的 `outputs` 数组中添加：

```typescript
outputs: [
  { id: 'prd', name: 'PRD文档', generatorPrompt: '...' },
  { id: 'user-persona', name: '用户画像', generatorPrompt: '...' },
  // 新增产出物
  { id: 'tech-spec', name: '技术方案', generatorPrompt: '...' },
]
```

### 6.3 自定义阶段

修改 `stages` 数组即可调整访谈流程：

```typescript
stages: [
  { id: 'opening', name: '开场', ... },
  { id: 'problem', name: '问题分析', ... },
  // 可以增删、调整顺序
]
```

---

## 7. 总结

Prompt 驱动架构的核心优势：

1. **低耦合** - 场景配置与核心代码分离
2. **高复用** - 语音交互层可被任意场景复用
3. **易扩展** - 新增场景只需添加配置
4. **可维护** - 修改行为无需改代码
5. **透明化** - 每个环节输入输出清晰可见

这种架构特别适合：
- 需要支持多种访谈场景的产品
- 需要频繁调整 AI 行为的场景
- 非技术人员也需要参与配置的团队
